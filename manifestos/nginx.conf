events {}

http {
    upstream minio {
    server minio:9000;
}

upstream console {
    ip_hash;
    server minio:9001;
}

server {
    listen       9000 ssl;
    listen  [::]:9000 ssl;
    server_name  ${NGINX_HOST};

    # To allow special characters in headers
    ignore_invalid_headers off;
    # Allow any size file to be uploaded.
    # Set to a value such as 1000m; to restrict file size to a specific value
    client_max_body_size 0;
    # To disable buffering
    proxy_buffering off;

    # SSL and Support TLSv1.3
    ssl_certificate /etc/nginx/www.stabledraw.com/www.stabledraw.com.pem;
    ssl_certificate_key /etc/nginx/www.stabledraw.com/www.stabledraw.com.key;
    ssl_trusted_certificate /etc/nginx/www.stabledraw.com/ca.pem;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384;
    ssl_prefer_server_ciphers off;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;
    error_page 497  https://$host$request_uri;

    # OCSP stapling
    ssl_stapling on;
    ssl_stapling_verify on;

    # replace with the IP address of your resolver
    resolver 127.0.0.11;

    # http security headers
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    add_header X-Frame-Options DENY;
    add_header Referrer-Policy "strict-origin-when-cross-origin";
    add_header X-Content-Type-Options nosniff;

    location / {
        proxy_set_header Host $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        proxy_connect_timeout 300;
        # Default is HTTP/1, keepalive is only enabled in HTTP/1.1
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        chunked_transfer_encoding off;

        proxy_pass http://minio;
    }
}



server {
    listen       8443 ssl;
    listen  [::]:8443 ssl;
    server_name  ${NGINX_HOST};

    # To allow special characters in headers
    ignore_invalid_headers off;
    # Allow any size file to be uploaded.
    # Set to a value such as 1000m; to restrict file size to a specific value
    client_max_body_size 1000m;
    # To disable buffering
    proxy_buffering off;

    # SSL and Support TLSv1.3
    ssl_certificate /etc/nginx/www.stabledraw.com/www.stabledraw.com.pem;
    ssl_certificate_key /etc/nginx/www.stabledraw.com/www.stabledraw.com.key;
    ssl_trusted_certificate /etc/nginx/www.stabledraw.com/ca.pem;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384;
    ssl_prefer_server_ciphers off;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;
    error_page 497  https://$host$request_uri;

    # OCSP stapling
    ssl_stapling on;
    ssl_stapling_verify on;

    # replace with the IP address of your resolver
    resolver 127.0.0.11;
	
    # http security headers
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    add_header X-Frame-Options DENY;
    add_header Referrer-Policy "strict-origin-when-cross-origin";
    add_header X-Content-Type-Options nosniff;

    location / {
        proxy_set_header Host $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-NginX-Proxy true;

        # This is necessary to pass the correct IP to be hashed
        real_ip_header X-Real-IP;

        proxy_connect_timeout 300;
        # Default is HTTP/1, keepalive is only enabled in HTTP/1.1
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        chunked_transfer_encoding off;

        proxy_pass http://console;
    }
}

# server {
#     listen 8080;
#     listen [::]:8080;
#     server_name ${STABLE_KITE_HOST} www.${STABLE_KITE_HOST};
#     location / {
#         # update port as needed for host mapped https
#         rewrite ^ https://stablekite.ru:43301$request_uri? permanent;
#     }
# }

# server {
#     listen       43301 ssl;
#     listen  [::]:43301 ssl;
#     server_name  stablekite.ru www.stablekite.ru;

#     ssl_certificate /etc/nginx/www.stablekite.ru/www.stablekite.ru.pem;
#     ssl_certificate_key /etc/nginx/www.stablekite.ru/www.stablekite.ru.key;
#     ssl_trusted_certificate /etc/nginx/www.stablekite.ru/ca.pem;

#     add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;

#     ssl_session_cache         shared:SSL:10m;
#     ssl_session_timeout       10m;

#     ssl_protocols             TLSv1 TLSv1.1 TLSv1.2;
#     ssl_prefer_server_ciphers on;
#     ssl_ciphers               "ECDH+AESGCM:ECDH+AES256:ECDH+AES128:!ADH:!AECDH:!MD5;";

#     root /var/www/html/web;
#     index index.php;

#     access_log /var/log/nginx/access.log;
#     error_log /var/log/nginx/error.log;

#     gzip on;
#     gzip_disable "msie6";

#     gzip_vary on;
#     gzip_proxied any;
#     gzip_comp_level 6;
#     gzip_buffers 16 8k;
#     gzip_http_version 1.1;
#     gzip_min_length 0;
#     gzip_types text/plain application/javascript text/css text/xml application/xml application/xml+rss text/javascript application/vnd.ms-fontobject application/x-font-ttf font/opentype;

#     client_max_body_size 1000M;

#     location ~ /.well-known/acme-challenge {
#         allow all;
#         root /var/www/html;
#     }

#     location / {
#         try_files $uri $uri/ /index.php$is_args$args;
#     }

#     location ~ \.php$ {
#         try_files $uri =404;
#         fastcgi_buffers 8 16k;
#         fastcgi_buffer_size 32k;
#         fastcgi_connect_timeout 60;
#         fastcgi_read_timeout 300;
#         fastcgi_split_path_info ^(.+\.php)(/.+)$;
#         fastcgi_pass wordpress:8000;
#         fastcgi_index index.php;
#         include fastcgi_params;
#         fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
#         fastcgi_param PATH_INFO $fastcgi_path_info;
#     }

#     location ~ /\.ht {
#             deny all;
#     }

#     location = /favicon.ico {
#             log_not_found off; access_log off;
#     }
#     location = /robots.txt {
#             log_not_found off; access_log off; allow all;
#     }
#     location ~* \.(css|gif|ico|jpeg|jpg|js|png)$ {
#             expires max;
#             log_not_found off;
#     }

# }

# server {
#     listen 8000;
#     server_name stablekite.ru www.stablekite.ru;

#     root /var/www/html;
#     index index.php;

#     location / {
#         try_files $uri $uri/  /index.php?$args;
#     }
    
#     access_log /var/log/nginx/site-access.log;
#     error_log /var/log/nginx/site-error.log;

#     location ~ \.php$ {
#         try_files $uri = 404;
#         fastcgi_split_path_info ^(.+\.php)(/.+)$;
#         fastcgi_pass wordpress:8081;
#         fastcgi_index index.php;
#         include fastcgi_params;
#         fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
#         fastcgi_param PATH_INFO $fastcgi_path_info;
#     }
# }

# server {
#     listen [::]:8080;
#     listen 8080;

#     server_name stablekite.ru www.stablekite.ru;

#     root /var/www/html;
#     index index.php;

#     location ~ /.well-known/acme-challenge {
#         allow all; 
#         root /var/www/html;
#     }

#     location / {
#         try_files $uri @apache;
#     }

#     location ~ ^/.user.ini {
#         deny all;
#     }

#     location ~*  .(svg|svgz)$ {
#         types {}
#         default_type image/svg+xml;
#     }

#     location = /favicon.ico {
#         log_not_found off;
#         access_log off;
#     }

#     location = /robots.txt {
#         allow all;
#         log_not_found off;
#         access_log off;
#     }

#     location @apache {
#         proxy_set_header X-Real-IP  $remote_addr;
#         proxy_set_header X-Forwarded-For $remote_addr;
#         proxy_set_header X-Forwarded-Proto $scheme;
#         proxy_set_header Host $host;
#         proxy_pass http://wordpress:80;
#     }

#     location ~[^?]*/$ {
#         proxy_set_header X-Real-IP  $remote_addr;
#         proxy_set_header X-Forwarded-For $remote_addr;
#         proxy_set_header X-Forwarded-Proto $scheme;
#         proxy_set_header Host $host;
#         proxy_pass http://wordpress:80;
#     }

#     location ~ .php$ {
#         proxy_set_header X-Real-IP  $remote_addr;
#         proxy_set_header X-Forwarded-For $remote_addr;
#         proxy_set_header X-Forwarded-Proto $scheme;
#         proxy_set_header Host $host;
#         proxy_pass http://wordpress:80;
#     }
# } 

}

